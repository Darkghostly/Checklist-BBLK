<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#111827">
    <title>RO-TEC-001 | Sistema de Controlo Operacional</title>
    
    <link rel="manifest" href="./manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #111827; }
        .task-item.completed label { text-decoration: line-through; color: #6b7280; }
        .task-item.expired { opacity: 0.5; border-color: #ef444455; background-color: #ef444405; }
        .task-item.expired label { color: #9ca3af; }
        .task-item.expired .deadline-label { color: #ef4444; font-weight: bold; }
        
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .accordion-content.open { max-height: 2000px; }
        .nav-link.active { background-color: #3b82f6; color: white; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }
        .status-dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; }
        .status-online { background-color: #10b981; box-shadow: 0 0 10px #10b981; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        
        input[type="checkbox"] {
            width: 1.5rem; height: 1.5rem; cursor: pointer; border-radius: 0.375rem;
            border: 2px solid #374151; background-color: #1f2937; appearance: none;
            position: relative; transition: all 0.2s;
        }
        input[type="checkbox"]:checked { background-color: #3b82f6; border-color: #3b82f6; }
        input[type="checkbox"]:disabled { cursor: not-allowed; background-color: #111827; border-color: #374151; }
        input[type="checkbox"]:checked::after {
            content: "\f00c"; font-family: "Font Awesome 6 Free"; font-weight: 900;
            color: white; font-size: 0.8rem; position: absolute;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
        }
    </style>
</head>
<body class="text-gray-200 flex flex-col md:flex-row h-screen overflow-hidden">

    <!-- Modal de Identificação -->
    <div id="login-modal" class="fixed inset-0 bg-gray-950/90 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-gray-900 p-8 rounded-2xl shadow-2xl max-w-sm w-full border border-gray-800">
            <div class="w-16 h-16 bg-blue-600/20 rounded-full flex items-center justify-center mb-6 mx-auto">
                <i class="fas fa-user-gear text-blue-500 text-2xl"></i>
            </div>
            <h2 class="text-2xl font-bold text-white mb-2 text-center">Acesso Técnico</h2>
            <p class="text-gray-400 mb-6 text-sm text-center">Identifique-se para sincronizar no projeto <b>checklist-bblk</b>.</p>
            <input type="text" id="user-name-input" placeholder="O seu nome" class="w-full bg-gray-800 border border-gray-700 rounded-xl p-4 text-white mb-4 outline-none">
            
            <!-- Seleção Inicial de Culto -->
            <label class="block text-xs text-gray-500 mb-1 uppercase font-bold">Selecione o Culto:</label>
            <select id="modal-service-select" class="w-full bg-gray-800 border border-gray-700 rounded-xl p-4 text-white mb-6 outline-none appearance-none">
                <option value="10:00">Domingo Manhã (10h)</option>
                <option value="18:00" selected>Domingo Noite (18h)</option>
                <option value="20:00">Quinta Feira (20h)</option>
            </select>

            <button id="start-app-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl transition-all">Começar Operação</button>
            <div id="auth-error-msg" class="mt-4 text-xs text-red-500 text-center hidden">Erro de ligação ao Firebase.</div>
        </div>
    </div>

    <!-- Sidebar -->
    <aside class="w-full md:w-72 bg-gray-900 p-6 space-y-6 flex-shrink-0 flex flex-col border-r border-gray-800 z-10">
        <div class="flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 p-2 rounded-lg"><i class="fas fa-bolt text-white"></i></div>
                <h1 class="text-xl font-black text-white uppercase">RO-TEC</h1>
            </div>
            <div class="flex items-center text-[10px] text-emerald-500 font-bold uppercase">
                <span class="status-dot status-online mr-2"></span> Cloud
            </div>
        </div>

        <!-- Seletor de Culto na Sidebar -->
        <div class="bg-gray-800 p-3 rounded-xl border border-gray-700">
            <label class="block text-[10px] text-gray-500 uppercase font-bold mb-2">Horário do Culto</label>
            <select id="sidebar-service-select" class="w-full bg-gray-900 text-white text-sm p-2 rounded-lg border border-gray-700 outline-none">
                <option value="10:00">Dom 10h</option>
                <option value="18:00">Dom 18h</option>
                <option value="20:00">Qui 20h</option>
            </select>
        </div>
        
        <nav class="flex flex-row md:flex-col md:space-y-2 space-x-2 md:space-x-0 overflow-x-auto scrollbar-hide">
            <a href="#iluminacao" class="nav-link text-left px-4 py-3 rounded-xl hover:bg-gray-800 active flex-shrink-0"><i class="fas fa-lightbulb w-6 mr-2"></i>Iluminação</a>
            <a href="#transmissao" class="nav-link text-left px-4 py-3 rounded-xl hover:bg-gray-800 flex-shrink-0"><i class="fas fa-video w-6 mr-2"></i>Transmissão</a>
            <a href="#admin" id="nav-admin" class="nav-link text-left px-4 py-3 rounded-xl hover:bg-gray-800 flex-shrink-0 text-gray-400 border-t border-gray-800 md:mt-4"><i class="fas fa-shield-halved w-6 mr-2"></i>Painel Líder</a>
        </nav>
        <div class="mt-auto hidden md:block p-4 bg-gray-800/50 rounded-xl border border-gray-800 text-center">
            <p id="event-clock" class="text-xl font-mono text-blue-400">00:00:00</p>
        </div>
    </aside>

    <main class="flex-1 p-4 md:p-8 overflow-y-auto bg-gray-950">
        <div id="view-operator">
            <header class="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-white">Checklist de Operação</h1>
                    <div class="flex items-center gap-3 mt-2">
                        <span id="display-operator-name" class="text-blue-400 text-[10px] font-bold uppercase tracking-widest">...</span>
                        <span id="display-service-time" class="text-gray-500 text-[10px] font-bold uppercase tracking-widest border-l border-gray-700 pl-3">Culto: --:--</span>
                    </div>
                </div>
                <button id="reset-session" class="text-gray-500 hover:text-red-500 text-sm"><i class="fas fa-sync-alt"></i> Reset</button>
            </header>

            <section id="iluminacao" class="section-content space-y-6">
                <!-- T-1h30 -->
                <div class="bg-gray-900 rounded-2xl border border-gray-800 overflow-hidden">
                    <button class="accordion-toggle w-full text-left p-5 font-bold flex justify-between items-center">
                        <span class="dynamic-title" data-base-title="Arranque Técnico" data-t-minus="90">T-1h30 – Arranque Técnico</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="accordion-content border-t border-gray-800 p-6 space-y-4">
                        <div class="task-item flex items-center p-2">
                            <!-- offset: minutos antes do culto (ex: 90 min antes) -->
                            <input type="checkbox" id="luz-1" class="cloud-sync" data-offset="90">
                            <label for="luz-1" class="ml-4 text-white">Ligar Disjuntores e Racks</label>
                            <span class="deadline-label ml-auto text-[10px] text-gray-500">--:--</span>
                        </div>
                        <div class="task-item flex items-center p-2">
                            <input type="checkbox" id="luz-2" class="cloud-sync" data-offset="75">
                            <label for="luz-2" class="ml-4 text-white">Boot GrandMA2 e Patch</label>
                            <span class="deadline-label ml-auto text-[10px] text-gray-500">--:--</span>
                        </div>
                    </div>
                </div>

                <!-- T-45min -->
                <div class="bg-gray-900 rounded-2xl border border-gray-800 overflow-hidden">
                    <button class="accordion-toggle w-full text-left p-5 font-bold flex justify-between items-center">
                        <span class="dynamic-title" data-base-title="Checklist Aparelhos" data-t-minus="45">T-45min – Checklist Aparelhos</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="accordion-content border-t border-gray-800 p-6 space-y-4">
                        <div class="task-item flex items-center p-2">
                            <input type="checkbox" id="luz-3" class="cloud-sync" data-offset="45">
                            <label for="luz-3" class="ml-4 text-white">Teste de Lâmpadas</label>
                            <span class="deadline-label ml-auto text-[10px] text-gray-500">--:--</span>
                        </div>
                         <div class="task-item flex items-center p-2">
                            <input type="checkbox" id="luz-4" class="cloud-sync" data-offset="30">
                            <label for="luz-4" class="ml-4 text-white">Preparar Haze/Fumo</label>
                            <span class="deadline-label ml-auto text-[10px] text-gray-500">--:--</span>
                        </div>
                    </div>
                </div>
            </section>

            <section id="transmissao" class="section-content space-y-6 hidden">
                <div class="bg-gray-900 rounded-2xl border border-gray-800 overflow-hidden">
                    <button class="accordion-toggle w-full text-left p-5 font-bold flex justify-between items-center">
                        <span class="dynamic-title" data-base-title="Engenharia de Vídeo" data-t-minus="90">T-1h30 – Engenharia de Vídeo</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="accordion-content border-t border-gray-800 p-6 space-y-4">
                        <div class="task-item flex items-center p-2">
                            <input type="checkbox" id="trans-1" class="cloud-sync" data-offset="90">
                            <label for="trans-1" class="ml-4 text-white">Ligar Switcher e Multiview</label>
                            <span class="deadline-label ml-auto text-[10px] text-gray-500">--:--</span>
                        </div>
                        <div class="task-item flex items-center p-2">
                            <input type="checkbox" id="trans-2" class="cloud-sync" data-offset="60">
                            <label for="trans-2" class="ml-4 text-white">Teste Sincronismo A/V</label>
                            <span class="deadline-label ml-auto text-[10px] text-gray-500">--:--</span>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <div id="view-admin" class="hidden">
            <h1 class="text-3xl font-bold text-white mb-6">Painel do Líder</h1>
            <div id="admin-cards-container" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCi1Z0FvzdUKDviRJaQ79f9AQQvq5ndw8k",
            authDomain: "checklist-bblk.firebaseapp.com",
            projectId: "checklist-bblk",
            storageBucket: "checklist-bblk.firebasestorage.app",
            messagingSenderId: "187345070674",
            appId: "1:187345070674:web:d3a203e3ad7cbe79a58d8b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'checklist-bblk';

        let operatorName = localStorage.getItem('op_name_v2') || "";
        let selectedTime = localStorage.getItem('service_time') || "18:00"; // Padrão 18h

        // REGISTO DO SW (Corrigido para evitar erro em preview)
        if ('serviceWorker' in navigator) {
            // Verifica se o protocolo suporta Service Worker (http ou https)
            if (window.location.protocol === 'http:' || window.location.protocol === 'https:') {
                window.addEventListener('load', () => navigator.serviceWorker.register('./service-worker.js')
                    .catch(err => console.log('SW falhou (pode ser ambiente local):', err)));
            }
        }

        // --- LÓGICA DE HORÁRIOS DINÂMICOS ---
        
        // Sincroniza os selects
        const sidebarSelect = document.getElementById('sidebar-service-select');
        const modalSelect = document.getElementById('modal-service-select');
        
        sidebarSelect.value = selectedTime;
        modalSelect.value = selectedTime;

        function updateServiceTime(newTime) {
            selectedTime = newTime;
            localStorage.setItem('service_time', newTime);
            sidebarSelect.value = newTime;
            modalSelect.value = newTime;
            document.getElementById('display-service-time').innerText = `Culto: ${newTime}`;
            recalculateDeadlines();
        }

        sidebarSelect.onchange = (e) => updateServiceTime(e.target.value);
        modalSelect.onchange = (e) => updateServiceTime(e.target.value);

        function recalculateDeadlines() {
            // Converte hora do culto (ex: "18:00") para objeto Date hoje
            const now = new Date();
            const [h, m] = selectedTime.split(':');
            const serviceDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, m, 0);

            // Atualiza cada tarefa com base no offset
            document.querySelectorAll('.cloud-sync').forEach(input => {
                const offsetMinutes = parseInt(input.getAttribute('data-offset')); // ex: 90
                const deadlineDate = new Date(serviceDate.getTime() - (offsetMinutes * 60000));
                
                const deadlineStr = deadlineDate.toLocaleTimeString('pt-PT', { hour: '2-digit', minute: '2-digit' });
                
                // Salva o novo deadline no atributo para o validador usar
                input.setAttribute('data-deadline', deadlineStr);
                
                // Atualiza a label visual
                const label = input.closest('.task-item').querySelector('.deadline-label');
                if (label && !input.disabled) {
                    label.innerText = deadlineStr;
                }
            });

            updateClock(); // Força revalidação imediata
        }

        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('pt-PT', { hour12: false, hour: '2-digit', minute: '2-digit' });
            document.getElementById('event-clock').innerText = timeStr;

            document.querySelectorAll('.cloud-sync').forEach(input => {
                const deadline = input.getAttribute('data-deadline');
                if (deadline) {
                    const taskItem = input.closest('.task-item');
                    // Se passou da hora e não está marcado -> Bloqueia
                    if (timeStr > deadline && !input.checked) {
                        input.disabled = true;
                        taskItem.classList.add('expired');
                        const label = taskItem.querySelector('.deadline-label');
                        if (label) label.innerHTML = `<i class="fas fa-lock mr-1"></i> ${deadline}`;
                    } else if (timeStr <= deadline) {
                        // Se voltou ao prazo (ex: mudou o culto para mais tarde)
                        input.disabled = false;
                        taskItem.classList.remove('expired');
                        const label = taskItem.querySelector('.deadline-label');
                        if (label) label.innerText = deadline;
                    }
                }
            });
        }
        setInterval(updateClock, 1000);

        // --- AUTH & FIREBASE ---
        onAuthStateChanged(auth, (user) => {
            if (user && operatorName) {
                document.getElementById('login-modal').classList.add('hidden');
                initOperatorView();
            } else if (!user) {
                signInAnonymously(auth);
            }
        });

        document.getElementById('start-app-btn').onclick = () => {
            const name = document.getElementById('user-name-input').value.trim();
            updateServiceTime(modalSelect.value); // Salva o horário escolhido no modal
            if (name) {
                operatorName = name;
                localStorage.setItem('op_name_v2', name);
                document.getElementById('login-modal').classList.add('hidden');
                initOperatorView();
            }
        };

        function initOperatorView() {
            if (!auth.currentUser) return;
            document.getElementById('display-operator-name').innerText = `Op: ${operatorName}`;
            document.getElementById('display-service-time').innerText = `Culto: ${selectedTime}`;
            recalculateDeadlines(); // Garante cálculo ao iniciar

            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'live_sessions', auth.currentUser.uid);
            
            onSnapshot(docRef, (snap) => {
                if (snap.exists()) {
                    const data = snap.data().tasks || {};
                    document.querySelectorAll('.cloud-sync').forEach(input => {
                        input.checked = !!data[input.id];
                        input.closest('.task-item').classList.toggle('completed', input.checked);
                    });
                }
            });

            document.querySelectorAll('.cloud-sync').forEach(input => {
                input.onchange = async () => {
                    const tasks = {};
                    document.querySelectorAll('.cloud-sync').forEach(i => tasks[i.id] = i.checked);
                    await setDoc(docRef, { name: operatorName, tasks, lastUpdate: new Date().toISOString() }, { merge: true });
                };
            });
            initAdminDashboard();
        }

        function initAdminDashboard() {
            const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'live_sessions');
            onSnapshot(colRef, (snap) => {
                const container = document.getElementById('admin-cards-container');
                container.innerHTML = "";
                snap.forEach(d => {
                    const data = d.data();
                    const done = Object.values(data.tasks || {}).filter(v => v).length;
                    const card = document.createElement('div');
                    card.className = "bg-gray-900 p-6 rounded-2xl border border-gray-800";
                    card.innerHTML = `<h3 class="font-bold text-white">${data.name}</h3><p class="text-xs text-blue-500 mt-2">${done} tarefas feitas</p>`;
                    container.appendChild(card);
                });
            });
        }

        document.getElementById('reset-session').onclick = async () => {
            if (confirm("Reset?") && auth.currentUser) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'live_sessions', auth.currentUser.uid));
                localStorage.removeItem('op_name_v2');
                location.reload();
            }
        };

        document.querySelectorAll('.nav-link').forEach(link => {
            link.onclick = (e) => {
                e.preventDefault();
                const target = link.getAttribute('href').substring(1);
                document.getElementById('view-operator').classList.toggle('hidden', target === 'admin');
                document.getElementById('view-admin').classList.toggle('hidden', target !== 'admin');
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                if (target !== 'admin') {
                    document.querySelectorAll('.section-content').forEach(s => s.classList.add('hidden'));
                    document.getElementById(target).classList.remove('hidden');
                }
            };
        });

        document.querySelectorAll('.accordion-toggle').forEach(btn => btn.onclick = () => btn.nextElementSibling.classList.toggle('open'));
        
        // Inicializa com valor padrão
        recalculateDeadlines();
    </script>
</body>
</html>